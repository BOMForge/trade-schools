<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Trade Schools Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #e1e8ed;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: #15202b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #38444d;
        }

        h1 {
            color: #1d9bf0;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-card {
            flex: 1;
            background: #253341;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #38444d;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1d9bf0;
        }

        .stat-label {
            font-size: 14px;
            color: #8899a6;
            text-transform: uppercase;
        }

        .filters {
            background: #15202b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #38444d;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #8899a6;
        }

        select, input {
            width: 100%;
            padding: 10px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 8px;
            color: #e1e8ed;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #1d9bf0;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #0d8bd9;
        }

        button.secondary {
            background: #38444d;
        }

        button.secondary:hover {
            background: #4a5561;
        }

        button.danger {
            background: #ff6b6b;
        }

        button.danger:hover {
            background: #ff5252;
        }

        button.success {
            background: #6bcf7f;
        }

        button.success:hover {
            background: #5abf6d;
        }

        .submissions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .submission-card {
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .submission-card:hover {
            border-color: #1d9bf0;
            box-shadow: 0 4px 12px rgba(29, 155, 240, 0.1);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .school-name {
            font-size: 20px;
            font-weight: 600;
            color: #1d9bf0;
            margin-bottom: 5px;
        }

        .submission-meta {
            font-size: 13px;
            color: #8899a6;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }

        .status-approved {
            background: rgba(107, 207, 127, 0.2);
            color: #6bcf7f;
        }

        .status-rejected {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .submission-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .field-group {
            background: #253341;
            padding: 12px;
            border-radius: 8px;
        }

        .field-label {
            font-size: 11px;
            color: #8899a6;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .field-value {
            font-size: 14px;
            color: #e1e8ed;
            word-break: break-word;
        }

        .programs-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .program-tag {
            background: #1d9bf0;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #38444d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8899a6;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #8899a6;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè´ Trade Schools Admin Dashboard</h1>
            <p style="color: #8899a6;">Review and manage school submissions</p>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="approvedCount">0</div>
                    <div class="stat-label">Approved Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total Submissions</div>
                </div>
            </div>
        </header>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Status Filter</label>
                    <select id="statusFilter" onchange="loadSubmissions()">
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>State Filter</label>
                    <select id="stateFilter" onchange="loadSubmissions()">
                        <option value="">All States</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search by school name..." oninput="loadSubmissions()">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="loadSubmissions()">üîÑ Refresh</button>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="submissionsList" class="submissions-list">
            <div class="loading">Loading submissions...</div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api/schools';

        // Load submissions on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSubmissions();
            populateStateFilter();
        });

        // Load submissions from API
        async function loadSubmissions() {
            const statusFilter = document.getElementById('statusFilter').value;
            const stateFilter = document.getElementById('stateFilter').value;
            const searchQuery = document.getElementById('searchInput').value;

            const listContainer = document.getElementById('submissionsList');
            listContainer.innerHTML = '<div class="loading">Loading submissions...</div>';

            try {
                // Build query params
                const params = new URLSearchParams();
                if (statusFilter !== 'all') params.append('status', statusFilter);
                if (stateFilter) params.append('state', stateFilter);
                if (searchQuery) params.append('search', searchQuery);

                // Fetch submissions
                const response = await fetch(`${API_BASE}/list?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                // Update stats
                if (data.stats) {
                    document.getElementById('pendingCount').textContent = data.stats.pending || 0;
                    document.getElementById('approvedCount').textContent = data.stats.approvedToday || 0;
                    document.getElementById('totalCount').textContent = data.stats.total || 0;
                }

                // Render submissions
                if (!data.submissions || data.submissions.length === 0) {
                    listContainer.innerHTML = '<div class="no-results">No submissions found</div>';
                    return;
                }

                listContainer.innerHTML = data.submissions.map(submission => renderSubmission(submission)).join('');

            } catch (error) {
                console.error('Error loading submissions:', error);
                listContainer.innerHTML = '<div class="error-message">Failed to load submissions. Please try again.</div>';
                showError('Failed to load submissions: ' + error.message);
            }
        }

        // Render a single submission card
        function renderSubmission(sub) {
            const statusClass = `status-${sub.status}`;
            return `
                <div class="submission-card" data-id="${sub.id}">
                    <div class="submission-header">
                        <div>
                            <div class="school-name">${escapeHtml(sub.school_name)}</div>
                            <div class="submission-meta">
                                üìç ${escapeHtml(sub.city)}, ${escapeHtml(sub.state)} ${escapeHtml(sub.zip_code)}<br>
                                üìÖ Submitted: ${formatDate(sub.submitted_at)}
                                ${sub.submitter_name ? `<br>üë§ By: ${escapeHtml(sub.submitter_name)}` : ''}
                            </div>
                        </div>
                        <span class="status-badge ${statusClass}">${sub.status.toUpperCase()}</span>
                    </div>

                    <div class="submission-body">
                        <div class="field-group">
                            <div class="field-label">Address</div>
                            <div class="field-value">${escapeHtml(sub.street_address)}</div>
                        </div>
                        <div class="field-group">
                            <div class="field-label">Contact Email</div>
                            <div class="field-value">
                                <a href="mailto:${escapeHtml(sub.contact_email)}" style="color: #1d9bf0;">${escapeHtml(sub.contact_email)}</a>
                            </div>
                        </div>
                        <div class="field-group">
                            <div class="field-label">Phone</div>
                            <div class="field-value">${escapeHtml(sub.phone)}</div>
                        </div>
                        <div class="field-group">
                            <div class="field-label">Website</div>
                            <div class="field-value">
                                ${sub.website ? `<a href="${escapeHtml(sub.website)}" target="_blank" style="color: #1d9bf0;">${escapeHtml(sub.website)}</a>` : 'N/A'}
                            </div>
                        </div>
                    </div>

                    ${sub.school_description ? `
                        <div class="field-group" style="margin-top: 15px;">
                            <div class="field-label">Description</div>
                            <div class="field-value">${escapeHtml(sub.school_description)}</div>
                        </div>
                    ` : ''}

                    <div class="programs-list">
                        ${JSON.parse(sub.programs || '[]').map(p => `<span class="program-tag">${escapeHtml(p)}</span>`).join('')}
                        ${sub.program_other ? `<span class="program-tag">Other: ${escapeHtml(sub.program_other)}</span>` : ''}
                    </div>

                    ${sub.status === 'pending' ? `
                        <div class="actions">
                            <button class="success" onclick="approveSubmission('${sub.id}')">‚úÖ Approve</button>
                            <button class="danger" onclick="rejectSubmission('${sub.id}')">‚ùå Reject</button>
                            <button class="secondary" onclick="viewDetails('${sub.id}')">üëÅÔ∏è View Details</button>
                        </div>
                    ` : ''}

                    ${sub.status === 'rejected' && sub.review_notes ? `
                        <div class="field-group" style="margin-top: 15px;">
                            <div class="field-label">Rejection Reason</div>
                            <div class="field-value">${escapeHtml(sub.review_notes)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Approve submission
        async function approveSubmission(id) {
            if (!confirm('Approve this school submission?')) return;

            try {
                const response = await fetch(`${API_BASE}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, reviewed_by: 'admin' })
                });

                if (!response.ok) {
                    throw new Error('Approval failed');
                }

                alert('School approved successfully!');
                loadSubmissions();
            } catch (error) {
                console.error('Error approving:', error);
                showError('Failed to approve submission');
            }
        }

        // Reject submission
        async function rejectSubmission(id) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason === null) return;

            try {
                const response = await fetch(`${API_BASE}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, reviewed_by: 'admin', notes: reason })
                });

                if (!response.ok) {
                    throw new Error('Rejection failed');
                }

                alert('Submission rejected');
                loadSubmissions();
            } catch (error) {
                console.error('Error rejecting:', error);
                showError('Failed to reject submission');
            }
        }

        // View submission details
        function viewDetails(id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Populate state filter
        function populateStateFilter() {
            const stateFilter = document.getElementById('stateFilter');
            const states = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'];
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
        }

        // Helper functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
