<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Trade Schools Map | BOMForge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=YOUR_RECAPTCHA_SITE_KEY"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .demo-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #1d9bf0, #ff6b6b, #6bcf7f);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #e1e8ed;
            height: 100vh;
            display: flex;
            padding-top: 40px;
        }
        
        #map {
            flex: 1;
            height: 100vh;
            background: #1a1f2e;
        }
        
        #sidebar {
            width: 400px;
            background: #192734;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #38444d;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            background: #15202b;
            border-bottom: 1px solid #38444d;
        }
        
        .header-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .nav-link {
            color: #8899a6;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(29, 155, 240, 0.1);
            color: #1d9bf0;
        }
        
        .nav-link.active {
            background: rgba(29, 155, 240, 0.2);
            color: #1d9bf0;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1d9bf0;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat {
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1d9bf0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8899a6;
            text-transform: uppercase;
        }
        
        .filters {
            padding: 20px;
            border-bottom: 1px solid #38444d;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #8899a6;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 8px;
            color: #e1e8ed;
            font-size: 14px;
            cursor: pointer;
        }
        
        .filter-select:hover {
            border-color: #1d9bf0;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #1d9bf0;
            box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 8px;
            color: #e1e8ed;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .search-input:hover {
            border-color: #1d9bf0;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1d9bf0;
            box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
        }
        
        .view-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .view-btn {
            flex: 1;
            padding: 10px 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 8px;
            color: #e1e8ed;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .view-btn:hover {
            border-color: #1d9bf0;
            background: #2a3f53;
            color: white;
            transform: translateY(-1px);
        }
        
        .view-btn.active {
            background: #1d9bf0;
            border-color: #1d9bf0;
            color: white;
            box-shadow: 0 2px 8px rgba(29, 155, 240, 0.3);
        }
        
        .mode-indicator {
            font-size: 10px;
            color: #8899a6;
            text-align: center;
            margin-bottom: 12px;
            padding: 6px;
            background: rgba(29, 155, 240, 0.1);
            border-radius: 6px;
            border-left: 3px solid #1d9bf0;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
        }
        
        .chart-title {
            color: #e1e8ed;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .chart-canvas {
            max-height: 300px;
        }
        
        .submission-form {
            margin-top: 20px;
            padding: 15px;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
        }
        
        .form-title {
            color: #e1e8ed;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #8899a6;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e1e8ed;
            font-size: 12px;
        }
        
        .form-input select {
            width: 100%;
            padding: 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e1e8ed;
            font-size: 12px;
            cursor: pointer;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1d9bf0;
        }
        
        .form-textarea {
            width: 100%;
            padding: 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e1e8ed;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #1d9bf0;
        }
        
        .submit-btn {
            width: 100%;
            padding: 10px;
            background: #1d9bf0;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .submit-btn:hover {
            background: #0d8bd9;
        }
        
        .submit-btn:disabled {
            background: #38444d;
            cursor: not-allowed;
        }

        /* Enhanced form styles */
        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-col-2 {
            flex: 1;
        }

        .field-error {
            color: #ff6b6b;
            font-size: 11px;
            margin-top: 4px;
            min-height: 15px;
            display: block;
        }

        .field-hint {
            color: #8899a6;
            font-size: 11px;
            margin-top: 4px;
        }

        .form-input.error,
        .form-textarea.error {
            border-color: #ff6b6b;
        }

        .form-input.success,
        .form-textarea.success {
            border-color: #6bcf7f;
        }

        .form-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .form-success {
            background: rgba(107, 207, 127, 0.15);
            border: 1px solid #6bcf7f;
            color: #6bcf7f;
        }

        .form-error {
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }

        .programs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .program-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }

        .program-checkbox:hover {
            border-color: #1d9bf0;
            background: rgba(29, 155, 240, 0.1);
        }

        .program-checkbox input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .program-checkbox input[type="checkbox"]:checked + span {
            color: #1d9bf0;
            font-weight: 600;
        }

        .recaptcha-notice {
            font-size: 10px;
            color: #8899a6;
            text-align: center;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .recaptcha-notice a {
            color: #1d9bf0;
            text-decoration: none;
        }

        .recaptcha-notice a:hover {
            text-decoration: underline;
        }
        
        .school-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .school-card {
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .school-card:hover {
            border-color: #1d9bf0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 155, 240, 0.1);
        }
        
        .school-name {
            font-size: 16px;
            font-weight: 600;
            color: #e1e8ed;
            margin-bottom: 8px;
        }
        
        .school-location {
            font-size: 14px;
            color: #8899a6;
            margin-bottom: 10px;
        }
        
        .school-programs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .program-tag {
            background: #1d9bf0;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .program-tag:hover {
            background: #0d8bd9;
            transform: scale(1.05);
        }
        
        .school-contact {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #38444d;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #8899a6;
        }
        
        .contact-item a {
            color: #1d9bf0;
            text-decoration: none;
        }
        
        .contact-item a:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #8899a6;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #8899a6;
        }
        
        /* Map markers */
        .school-marker {
            background: #1d9bf0;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .school-marker.selected {
            background: #ff6b6b;
            width: 16px;
            height: 16px;
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2);
        }
        
        /* Popup styles */
        .leaflet-popup-content-wrapper {
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 12px;
        }
        
        .leaflet-popup-content {
            margin: 12px;
            color: #e1e8ed;
        }
        
        .leaflet-popup-tip {
            background: #15202b;
            border: 1px solid #38444d;
        }
        
        /* Hex label styles */
        .hex-label {
            z-index: 1000 !important;
            pointer-events: none;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            background: #15202b;
            border: 2px solid #1d9bf0;
            box-shadow: 0 4px 20px rgba(29, 155, 240, 0.3);
        }
        
        .custom-popup .leaflet-popup-tip {
            background: #15202b;
            border: 2px solid #1d9bf0;
        }
        
        /* Program Legend */
        .program-legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(21, 32, 43, 0.95);
            border: 1px solid #38444d;
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .program-legend.active {
            display: block;
        }
        
        .legend-title {
            font-size: 14px;
            font-weight: 600;
            color: #e1e8ed;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #8899a6;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid #38444d;
        }
        
        .legend-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(21, 32, 43, 0.95);
            border: 1px solid #38444d;
            border-radius: 8px;
            padding: 8px 12px;
            z-index: 999;
            cursor: pointer;
            font-size: 12px;
            color: #e1e8ed;
            transition: all 0.2s;
        }
        
        .legend-toggle:hover {
            background: #1d9bf0;
            border-color: #1d9bf0;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 50vh;
            }
            
            #map {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="demo-banner">
        üöÄ ENHANCED: Zoom-Adaptive Hex Grid | Smart Viewport Filtering | 989 Schools Mapped<br>
        ‚¨° Hex Grid auto-adjusts resolution ‚Ä¢ üìç Markers auto-filter at zoom 6+ ‚Ä¢ üå°Ô∏è Heat Map shows all data
    </div>
    
    <div id="map"></div>
    
    <!-- Program Legend -->
    <div class="legend-toggle" id="legendToggle" onclick="toggleLegend()">
        üé® Show Legend
    </div>
    <div class="program-legend" id="programLegend">
        <div class="legend-title">
            <span>üé®</span>
            <span>Program Colors</span>
        </div>
        <div class="legend-items" id="legendItems"></div>
    </div>
    
    <div id="sidebar">
        <div class="header">
            <div class="header-nav">
                <a href="index.html" class="nav-link">üè† Home</a>
                <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
                <a href="clean-map.html" class="nav-link active">üó∫Ô∏è Map</a>
            </div>
            <h1>üéì Trade Schools Directory</h1>
            <div class="stats">
                <div class="stat" onclick="zoomToFullMap()" style="cursor: pointer;" title="Click to zoom out to full map">
                    <div class="stat-value" id="totalSchools">0</div>
                    <div class="stat-label">Schools</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalStates">0</div>
                    <div class="stat-label">States</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="visibleCount">0</div>
                    <div class="stat-label">Visible</div>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Search Schools</label>
                <input type="text" class="search-input" id="searchInput" placeholder="Search by name, city, or program...">
            </div>
            <div class="filter-group">
                <label class="filter-label">Visualization Mode</label>
                <div class="view-controls">
                    <button class="view-btn" id="markersBtn" onclick="setView('markers')" title="Individual school markers (auto-filters at zoom level 6+)">üìç Markers</button>
                    <button class="view-btn" id="heatmapBtn" onclick="setView('heatmap')" title="Density heatmap showing concentration">üå°Ô∏è Heat Map</button>
                    <button class="view-btn active" id="hexgridBtn" onclick="setView('hexgrid')" title="Program-coded hexagons with zoom-adaptive resolution">‚¨° Hex Grid</button>
                </div>
                <div class="mode-indicator" id="modeIndicator" style="display: none;">
                    <span id="modeText"></span>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">Filter by State</label>
                <select class="filter-select" id="stateFilter">
                    <option value="">All States</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Filter by Program</label>
                <select class="filter-select" id="programFilter">
                    <option value="">All Programs</option>
                </select>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title" id="chartTitle">üìä Program Distribution</div>
            <canvas id="programChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="submission-form">
            <div class="form-title">üè´ Submit a School</div>
            <div id="formSuccessMessage" class="form-message form-success" style="display: none;"></div>
            <div id="formErrorMessage" class="form-message form-error" style="display: none;"></div>

            <form id="schoolSubmissionForm" novalidate>
                <div class="form-group">
                    <label class="form-label">School Name *</label>
                    <input type="text" class="form-input" id="schoolName" name="schoolName" required minlength="2" maxlength="100">
                    <div class="field-error" id="schoolName-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Street Address *</label>
                    <input type="text" class="form-input" id="streetAddress" name="streetAddress" placeholder="123 Main Street" required minlength="5" maxlength="200">
                    <div class="field-error" id="streetAddress-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">City *</label>
                    <input type="text" class="form-input" id="city" name="city" required minlength="2" maxlength="50">
                    <div class="field-error" id="city-error"></div>
                </div>

                <div class="form-row">
                    <div class="form-group form-col-2">
                        <label class="form-label">State *</label>
                        <select class="form-input" id="state" name="state" required>
                            <option value="">Select State</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>
                        <div class="field-error" id="state-error"></div>
                    </div>

                    <div class="form-group form-col-2">
                        <label class="form-label">ZIP Code *</label>
                        <input type="text" class="form-input" id="zipCode" name="zipCode" placeholder="12345" required pattern="^\d{5}(-\d{4})?$" maxlength="10">
                        <div class="field-error" id="zipCode-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Contact Email *</label>
                    <input type="email" class="form-input" id="contactEmail" name="contactEmail" placeholder="info@school.edu" required>
                    <div class="field-error" id="contactEmail-error"></div>
                    <div class="field-hint">Primary contact email for the school</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-input" id="phone" name="phone" placeholder="(555) 123-4567" required>
                    <div class="field-error" id="phone-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" class="form-input" id="website" name="website" placeholder="https://www.school.edu">
                    <div class="field-error" id="website-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Programs Offered * (select all that apply)</label>
                    <div class="programs-grid" id="programsGrid">
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Welding">
                            <span>Welding</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Diesel & Automotive Technology">
                            <span>Diesel & Automotive</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="HVAC (Heating, Ventilation, and Air Conditioning)">
                            <span>HVAC</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Machine Tool Technology & Mechanical Systems">
                            <span>Machine Tool Tech</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Construction & Building Technology">
                            <span>Construction</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Electronics Technology">
                            <span>Electronics</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="CAD/CAM Drafting & Design">
                            <span>CAD/CAM Drafting</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Plumbing & Pipefitting">
                            <span>Plumbing</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Woodworking & Carpentry">
                            <span>Woodworking</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Electrical Technology">
                            <span>Electrical</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Industrial Maintenance">
                            <span>Industrial Maintenance</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Machining & CNC">
                            <span>Machining & CNC</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Robotics & Automation">
                            <span>Robotics</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Manufacturing Technology">
                            <span>Manufacturing</span>
                        </label>
                        <label class="program-checkbox">
                            <input type="checkbox" name="programs" value="Other" id="programOtherCheckbox">
                            <span>Other</span>
                        </label>
                    </div>
                    <div class="field-error" id="programs-error"></div>
                </div>

                <div class="form-group" id="programOtherGroup" style="display: none;">
                    <label class="form-label">Specify Other Program</label>
                    <input type="text" class="form-input" id="programOther" name="programOther" placeholder="Enter program name" maxlength="100">
                    <div class="field-error" id="programOther-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">School Description (optional)</label>
                    <textarea class="form-textarea" id="schoolDescription" name="schoolDescription" placeholder="Brief description of the school and its offerings..." maxlength="500" rows="3"></textarea>
                    <div class="field-hint"><span id="descriptionCount">0</span>/500 characters</div>
                    <div class="field-error" id="schoolDescription-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Your Name (optional)</label>
                    <input type="text" class="form-input" id="submitterName" name="submitterName" placeholder="For contact purposes" maxlength="100">
                    <div class="field-error" id="submitterName-error"></div>
                </div>

                <div class="recaptcha-notice">
                    This site is protected by reCAPTCHA and the Google
                    <a href="https://policies.google.com/privacy" target="_blank">Privacy Policy</a> and
                    <a href="https://policies.google.com/terms" target="_blank">Terms of Service</a> apply.
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span id="submitBtnText">Submit School</span>
                    <span id="submitBtnLoading" style="display: none;">Submitting...</span>
                </button>
            </form>
        </div>
        
        <div class="school-list" id="schoolList">
            <div class="loading">Loading schools...</div>
        </div>
    </div>
    
    <script>
        // Program color mapping - Updated to match interface legend
        const PROGRAM_COLORS = {
            'Welding': '#ff5959',
            'HVAC': '#4ea3ff',
            'HVAC (Heating, Ventilation, and Air Conditioning)': '#4ea3ff',
            'Construction': '#ff9b42',
            'Construction & Building Technology': '#ff9b42',
            'CAD/CAM Drafting': '#d49f68',
            'CAD/CAM Drafting & Design': '#d49f68',
            'Woodworking & Carpentry': '#4db6ac',
            'Mechatronics': '#a17fff',
            'Diesel & Automotive Tech': '#35b276',
            'Diesel & Automotive Technology': '#35b276',
            'Machine & Mechanical Systems': '#a17fff',
            'Machine Tool Technology & Mechanical Systems': '#a17fff',
            'Electronics': '#f7e35b',
            'Electronics Technology': '#f7e35b',
            'Plumbing & Pipefitting': '#aaaaaa',
            'Machining': '#da70d6',
            'Machining & CNC': '#da70d6',
            'Electrical Technology': '#ffa07a',
            'Industrial Maintenance': '#87ceeb',
            'Robotics & Automation': '#ff69b4',
            'Manufacturing Technology': '#20b2aa',
            'default': '#8899a6'
        };
        
        // Get color for a program with improved matching
        function getProgramColor(program) {
            if (!program) return PROGRAM_COLORS['default'];
            
            // Direct match first
            if (PROGRAM_COLORS[program]) {
                return PROGRAM_COLORS[program];
            }
            
            // Try partial matching for common variations
            const programLower = program.toLowerCase();
            for (const [key, color] of Object.entries(PROGRAM_COLORS)) {
                if (key === 'default') continue;
                
                const keyLower = key.toLowerCase();
                // Check if program contains key or key contains program
                if (programLower.includes(keyLower) || keyLower.includes(programLower)) {
                    return color;
                }
                
                // Check for common abbreviations and variations
                const variations = {
                    'hvac': ['heating', 'ventilation', 'air conditioning'],
                    'cad': ['computer aided design', 'drafting'],
                    'cnc': ['computer numerical control'],
                    'automotive': ['auto', 'vehicle'],
                    'construction': ['building', 'construction'],
                    'welding': ['weld'],
                    'electronics': ['electronic'],
                    'electrical': ['electric'],
                    'plumbing': ['pipe', 'pipefitting'],
                    'machining': ['machine', 'cnc'],
                    'robotics': ['robot', 'automation']
                };
                
                for (const [base, terms] of Object.entries(variations)) {
                    if (keyLower.includes(base) && terms.some(term => programLower.includes(term))) {
                        return color;
                    }
                }
            }
            
            console.warn(`No color found for program: "${program}"`);
            return PROGRAM_COLORS['default'];
        }
        
        // Get top N programs across all schools
        function getTopPrograms(schools, n = 10) {
            const programCounts = {};
            schools.forEach(school => {
                school.programs.forEach(program => {
                    programCounts[program] = (programCounts[program] || 0) + 1;
                });
            });
            return Object.entries(programCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, n);
        }
        
        // Initialize legend
        function initializeLegend() {
            const topPrograms = getTopPrograms(allSchools, 12);
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = topPrograms.map(([program, count]) => {
                const shortName = program.length > 20 ? program.substring(0, 17) + '...' : program;
                return `
                    <div class="legend-item" title="${program}">
                        <div class="legend-color" style="background: ${getProgramColor(program)}"></div>
                        <span>${shortName}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle legend visibility
        function toggleLegend() {
            const legend = document.getElementById('programLegend');
            const toggle = document.getElementById('legendToggle');
            legend.classList.toggle('active');
            toggle.textContent = legend.classList.contains('active') ? 'üé® Hide Legend' : 'üé® Show Legend';
        }
        
        // Initialize map
        const map = L.map('map', {
            center: [39.8283, -98.5795],
            zoom: 4,
            minZoom: 3,
            maxZoom: 18
        });
        
        // Add dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Chart instance
        let programChart = null;
        
        // Data storage
        let allSchools = [];
        let filteredSchools = [];
        let viewportSchools = []; // Schools visible in current viewport
        let schoolMarkers = {};
        let markersLayer = L.layerGroup().addTo(map);
        let heatmapLayer = null;
        let hexLayer = L.layerGroup();
        let selectedMarker = null;
        let currentView = 'hexgrid'; // Default to hex grid view
        
        // Load geocoded data with improved error handling
        function loadGeocodedData() {
            console.log('Starting to load geocoded data...');
            
            // Try multiple file paths for deployment compatibility
            const csvPaths = [
                'schools/trade_schools_geocoded_fixed.csv',
                './schools/trade_schools_geocoded_fixed.csv',
                'trade_schools_geocoded_fixed.csv'
            ];
            
            const matchmakingPaths = [
                'schools/matchmaking_index.csv',
                './schools/matchmaking_index.csv',
                'matchmaking_index.csv'
            ];
            
            let attempts = 0;
            const maxAttempts = csvPaths.length;
            
            function tryLoadData(csvIndex = 0) {
                if (csvIndex >= csvPaths.length) {
                    console.error('All CSV loading attempts failed, loading sample data');
                    loadSampleData();
                    return;
                }
                
                console.log(`Attempting to load CSV from: ${csvPaths[csvIndex]}`);
                
                Papa.parse(csvPaths[csvIndex], {
                    download: true,
                    header: true,
                    complete: function(geoResults) {
                        console.log(`‚úÖ Geocoded data loaded from ${csvPaths[csvIndex]}:`, geoResults.data.length, 'rows');
                        
                        // Try to load matchmaking data
                        tryLoadMatchmakingData(geoResults.data, 0);
                    },
                    error: function(error) {
                        console.warn(`‚ùå Failed to load ${csvPaths[csvIndex]}:`, error);
                        tryLoadData(csvIndex + 1);
                    }
                });
            }
            
            function tryLoadMatchmakingData(geoData, matchIndex = 0) {
                if (matchIndex >= matchmakingPaths.length) {
                    console.warn('Matchmaking data not found, processing with empty programs');
                    processData(geoData, []);
                    return;
                }
                
                console.log(`Attempting to load matchmaking data from: ${matchmakingPaths[matchIndex]}`);
                
                Papa.parse(matchmakingPaths[matchIndex], {
                    download: true,
                    header: true,
                    complete: function(matchResults) {
                        console.log(`‚úÖ Matchmaking data loaded from ${matchmakingPaths[matchIndex]}:`, matchResults.data.length, 'rows');
                        processData(geoData, matchResults.data);
                    },
                    error: function(error) {
                        console.warn(`‚ùå Failed to load ${matchmakingPaths[matchIndex]}:`, error);
                        tryLoadMatchmakingData(geoData, matchIndex + 1);
                    }
                });
            }
            
            tryLoadData();
        }
        
        // Load sample data as fallback
        function loadSampleData() {
            console.log('Loading sample data as fallback...');
            
            // Generate more realistic sample data with geographic clustering for better aggregations
            const sampleSchools = [
                // California cluster
                { name: "Los Angeles Trade School", state: "CA", city: "Los Angeles", lat: 34.0522, lon: -118.2437, programs: ["Welding", "HVAC"], website: "https://example.com" },
                { name: "San Francisco Technical Institute", state: "CA", city: "San Francisco", lat: 37.7749, lon: -122.4194, programs: ["Construction", "Electronics"], website: "https://example.com" },
                { name: "San Diego Vocational College", state: "CA", city: "San Diego", lat: 32.7157, lon: -117.1611, programs: ["HVAC", "Plumbing"], website: "https://example.com" },
                { name: "Sacramento Trade Center", state: "CA", city: "Sacramento", lat: 38.5816, lon: -121.4944, programs: ["Welding", "Construction"], website: "https://example.com" },
                { name: "Fresno Technical School", state: "CA", city: "Fresno", lat: 36.7378, lon: -119.7871, programs: ["Diesel & Automotive Tech", "Electronics"], website: "https://example.com" },
                
                // Texas cluster
                { name: "Houston Trade Institute", state: "TX", city: "Houston", lat: 29.7604, lon: -95.3698, programs: ["Construction", "Electronics"], website: "https://example.com" },
                { name: "Dallas Technical College", state: "TX", city: "Dallas", lat: 32.7767, lon: -96.7970, programs: ["HVAC", "Welding"], website: "https://example.com" },
                { name: "Austin Vocational School", state: "TX", city: "Austin", lat: 30.2672, lon: -97.7431, programs: ["Electronics", "CAD/CAM Drafting"], website: "https://example.com" },
                { name: "San Antonio Trade Center", state: "TX", city: "San Antonio", lat: 29.4241, lon: -98.4936, programs: ["Construction", "Plumbing"], website: "https://example.com" },
                { name: "Fort Worth Technical Institute", state: "TX", city: "Fort Worth", lat: 32.7555, lon: -97.3308, programs: ["Welding", "Diesel & Automotive Tech"], website: "https://example.com" },
                
                // New York cluster
                { name: "New York Trade School", state: "NY", city: "New York", lat: 40.7128, lon: -74.0060, programs: ["HVAC", "Plumbing"], website: "https://example.com" },
                { name: "Buffalo Technical College", state: "NY", city: "Buffalo", lat: 42.8864, lon: -78.8784, programs: ["Construction", "Welding"], website: "https://example.com" },
                { name: "Rochester Vocational Institute", state: "NY", city: "Rochester", lat: 43.1566, lon: -77.6088, programs: ["Electronics", "HVAC"], website: "https://example.com" },
                { name: "Albany Trade Center", state: "NY", city: "Albany", lat: 42.6526, lon: -73.7562, programs: ["Plumbing", "Construction"], website: "https://example.com" },
                
                // Florida cluster
                { name: "Miami Technical School", state: "FL", city: "Miami", lat: 25.7617, lon: -80.1918, programs: ["HVAC", "Electronics"], website: "https://example.com" },
                { name: "Tampa Vocational College", state: "FL", city: "Tampa", lat: 27.9506, lon: -82.4572, programs: ["Construction", "Welding"], website: "https://example.com" },
                { name: "Orlando Trade Institute", state: "FL", city: "Orlando", lat: 28.5383, lon: -81.3792, programs: ["HVAC", "Plumbing"], website: "https://example.com" },
                { name: "Jacksonville Technical Center", state: "FL", city: "Jacksonville", lat: 30.3322, lon: -81.6557, programs: ["Diesel & Automotive Tech", "Electronics"], website: "https://example.com" },
                
                // Illinois cluster
                { name: "Chicago Trade School", state: "IL", city: "Chicago", lat: 41.8781, lon: -87.6298, programs: ["Construction", "HVAC"], website: "https://example.com" },
                { name: "Springfield Technical Institute", state: "IL", city: "Springfield", lat: 39.7817, lon: -89.6501, programs: ["Welding", "Electronics"], website: "https://example.com" },
                { name: "Rockford Vocational College", state: "IL", city: "Rockford", lat: 42.2711, lon: -89.0940, programs: ["Plumbing", "Construction"], website: "https://example.com" },
                
                // Pennsylvania cluster
                { name: "Philadelphia Trade Center", state: "PA", city: "Philadelphia", lat: 39.9526, lon: -75.1652, programs: ["HVAC", "Welding"], website: "https://example.com" },
                { name: "Pittsburgh Technical School", state: "PA", city: "Pittsburgh", lat: 40.4406, lon: -79.9959, programs: ["Construction", "Electronics"], website: "https://example.com" },
                { name: "Harrisburg Vocational Institute", state: "PA", city: "Harrisburg", lat: 40.2737, lon: -76.8844, programs: ["Plumbing", "HVAC"], website: "https://example.com" },
                
                // Ohio cluster
                { name: "Columbus Trade School", state: "OH", city: "Columbus", lat: 39.9612, lon: -82.9988, programs: ["Electronics", "Construction"], website: "https://example.com" },
                { name: "Cleveland Technical College", state: "OH", city: "Cleveland", lat: 41.4993, lon: -81.6944, programs: ["Welding", "HVAC"], website: "https://example.com" },
                { name: "Cincinnati Vocational Center", state: "OH", city: "Cincinnati", lat: 39.1031, lon: -84.5120, programs: ["Diesel & Automotive Tech", "Plumbing"], website: "https://example.com" },
                
                // Michigan cluster
                { name: "Detroit Trade Institute", state: "MI", city: "Detroit", lat: 42.3314, lon: -83.0458, programs: ["Welding", "Diesel & Automotive Tech"], website: "https://example.com" },
                { name: "Grand Rapids Technical School", state: "MI", city: "Grand Rapids", lat: 42.9634, lon: -85.6681, programs: ["Construction", "Electronics"], website: "https://example.com" },
                { name: "Lansing Vocational College", state: "MI", city: "Lansing", lat: 42.7325, lon: -84.5555, programs: ["HVAC", "Plumbing"], website: "https://example.com" }
            ];
            
            allSchools = sampleSchools;
            filteredSchools = [...allSchools];
            
            console.log('Sample data loaded:', allSchools.length, 'schools');
            
            // Initialize UI with sample data
            populateFilters();
            updateStats();
            displaySchools();
            updateMapView();
            updateProgramChart();
            initializeLegend();
            
            // Ensure hex grid shows with sample data
            console.log(`Sample data loaded: ${allSchools.length} schools, rendering initial view...`);
            updateMapView();
            
            // Show sample data notice
            document.getElementById('schoolList').innerHTML = 
                '<div class="no-results" style="background: #ffeb3b; color: #000; padding: 10px; border-radius: 5px; margin-bottom: 10px;">' +
                '‚ö†Ô∏è Sample data loaded. CSV files not accessible. Check deployment configuration.' +
                '</div>' + document.getElementById('schoolList').innerHTML;
        }
        
        // Process and merge data
        function processData(geoData, matchData) {
            // Group matchmaking data by institution
            const schoolPrograms = {};
            matchData.forEach(row => {
                const key = `${row['Institution Name']}_${row.State}_${row.City}`;
                if (!schoolPrograms[key]) {
                    schoolPrograms[key] = {
                        programs: [],
                        email: row['Contact Email'] || '',
                        website: row.Website || ''
                    };
                }
                if (row.program) {
                    schoolPrograms[key].programs.push(row.program);
                }
            });
            
            // Process geocoded schools
            allSchools = [];
            console.log('Processing geoData:', geoData.length, 'rows');
            let processedCount = 0;
            geoData.forEach(row => {
                if (row.geocoded === 'True' && row.lat && row.lon) {
                    processedCount++;
                    const key = `${row['Institution Name']}_${row.State}_${row.City}`;
                    const programData = schoolPrograms[key] || { programs: [], email: '', website: '' };
                    
                    // Deduplicate programs
                    const uniquePrograms = [...new Set(programData.programs)];
                    
                    // Clean website URL (remove trailing slash)
                    let cleanWebsite = programData.website || '';
                    if (cleanWebsite && cleanWebsite.endsWith('/')) {
                        cleanWebsite = cleanWebsite.slice(0, -1);
                    }
                    
                    allSchools.push({
                        name: row['Institution Name'],
                        state: row.State,
                        city: row.City,
                        lat: parseFloat(row.lat),
                        lon: parseFloat(row.lon),
                        programs: uniquePrograms,
                        website: cleanWebsite
                    });
                }
            });
            
            console.log(`Processed ${processedCount} schools that passed geocoded filter`);
            console.log(`Loaded ${allSchools.length} schools with coordinates`);
            console.log(`Note: ${geoData.filter(r => r.geocoded === 'False').length} schools failed geocoding and are not displayed`);
            
            // Debug program data
            const programStats = {};
            allSchools.forEach(school => {
                school.programs.forEach(program => {
                    programStats[program] = (programStats[program] || 0) + 1;
                });
            });
            
            console.log('Program distribution:', Object.entries(programStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([prog, count]) => `${prog}: ${count}`)
                .join(', '));
            
            // Show data status
            const totalInFile = geoData.length - 1; // minus any empty rows
            const mappedCount = allSchools.length;
            const missingCount = totalInFile - mappedCount;
            
            console.log(`üìä Data Status: ${mappedCount}/${totalInFile} schools mapped`);
            
            // Only show alert if significant number missing
            if (missingCount > 50) {
                alert(`üìä Data Status:\n\n‚úÖ ${mappedCount} schools successfully mapped\n‚ö†Ô∏è ${missingCount} schools still missing coordinates\nüìä Total: ${totalInFile} schools in database\n\nWe've recovered many schools but some still need manual geocoding.`);
            }
            
            // Initialize UI
            filteredSchools = [...allSchools];
            populateFilters();
            updateStats();
            displaySchools();
            updateMapView();
            updateProgramChart();
            initializeLegend();
            
            // Ensure initial view is rendered
            console.log(`Initializing with ${allSchools.length} schools, default view: ${currentView}`);
            console.log('Rendering initial view...');
            updateMapView();
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            // State filter
            const states = {};
            const programs = {};
            
            allSchools.forEach(school => {
                // Count states
                if (school.state) {
                    states[school.state] = (states[school.state] || 0) + 1;
                }
                
                // Count programs
                school.programs.forEach(program => {
                    programs[program] = (programs[program] || 0) + 1;
                });
            });
            
            // Populate state filter
            const stateFilter = document.getElementById('stateFilter');
            Object.entries(states)
                .sort((a, b) => b[1] - a[1])
                .forEach(([state, count]) => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = `${state} (${count})`;
                    stateFilter.appendChild(option);
                });
            
            // Populate program filter
            const programFilter = document.getElementById('programFilter');
            Object.entries(programs)
                .sort((a, b) => b[1] - a[1])
                .forEach(([program, count]) => {
                    const option = document.createElement('option');
                    option.value = program;
                    option.textContent = `${program} (${count})`;
                    programFilter.appendChild(option);
                });
        }
        
        // Update statistics
        function updateStats() {
            const schoolsToShow = getViewportSchools();
            const zoom = map.getZoom();
            const isViewportFiltered = currentView === 'markers' && zoom >= 6;
            
            // Only count actual US states (50 states, not territories)
            const usStates = new Set(['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY']);
            const usSchools = allSchools.filter(s => usStates.has(s.state));
            const usSchoolsInViewport = schoolsToShow.filter(s => usStates.has(s.state));
            
            const stateCount = new Set(usSchools.map(s => s.state)).size;
            const viewportStateCount = new Set(usSchoolsInViewport.map(s => s.state)).size;
            
            document.getElementById('totalSchools').textContent = allSchools.length;
            document.getElementById('totalStates').textContent = isViewportFiltered ? viewportStateCount : stateCount;
            document.getElementById('visibleCount').textContent = schoolsToShow.length;
        }
        
        // Display schools in sidebar
        function displaySchools() {
            const container = document.getElementById('schoolList');
            const schoolsToShow = getViewportSchools();
            
            if (schoolsToShow.length === 0) {
                container.innerHTML = '<div class="no-results">No schools visible in current map view</div>';
                return;
            }
            
            container.innerHTML = schoolsToShow.map(school => {
                const websiteUrl = school.website ? 
                    (school.website.startsWith('http') ? school.website : `https://${school.website}`) : '';
                
                // Clean display name for website (remove protocol and trailing slash)
                let websiteDisplay = school.website || '';
                if (websiteDisplay) {
                    websiteDisplay = websiteDisplay.replace(/^https?:\/\//, '').replace(/\/$/, '');
                }
                
                return `
                    <div class="school-card" data-name="${school.name}" onclick="selectSchool('${school.name}')">
                        <div class="school-name">${school.name}</div>
                        <div class="school-location">üìç ${school.city}, ${school.state}</div>
                        ${school.programs.length > 0 ? `
                            <div class="school-programs">
                                ${school.programs.slice(0, 4).map(p => 
                                    `<span class="program-tag" onclick="filterByProgram('${p}')">${p}</span>`
                                ).join('')}
                                ${school.programs.length > 4 ? 
                                    `<span class="program-tag" onclick="showAllPrograms('${school.name}')">+${school.programs.length - 4} more</span>` : ''}
                            </div>
                        ` : ''}
                        ${websiteUrl ? `
                            <div class="school-contact">
                                <div class="contact-item">
                                    üåê <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer">
                                        ${websiteDisplay}
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Add markers to map
        function addMarkersToMap() {
            markersLayer.clearLayers();
            schoolMarkers = {};
            
            filteredSchools.forEach(school => {
                const marker = L.circleMarker([school.lat, school.lon], {
                    radius: 6,
                    fillColor: '#1d9bf0',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Create popup
                const websiteUrl = school.website ? 
                    (school.website.startsWith('http') ? school.website : `https://${school.website}`) : '';
                
                // Clean display name for website
                let websiteDisplay = school.website || '';
                if (websiteDisplay) {
                    websiteDisplay = websiteDisplay.replace(/^https?:\/\//, '').replace(/\/$/, '');
                }
                
                const popupContent = `
                    <div style="min-width: 200px;">
                        <strong style="color: #1d9bf0;">${school.name}</strong><br>
                        üìç ${school.city}, ${school.state}<br>
                        ${websiteUrl ? `üåê <a href="${websiteUrl}" target="_blank">${websiteDisplay}</a><br>` : ''}
                        ${school.programs.length > 0 ? `<br><strong>Programs:</strong><br>${school.programs.join(', ')}` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', function() {
                    selectSchool(school.name);
                    // Scroll to card in sidebar
                    const card = document.querySelector(`[data-name="${school.name}"]`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
                
                markersLayer.addLayer(marker);
                schoolMarkers[school.name] = marker;
            });
        }
        
        // Select school
        function selectSchool(schoolName) {
            const school = getViewportSchools().find(s => s.name === schoolName);
            if (!school) return;
            
            // Update marker styles
            Object.values(schoolMarkers).forEach(marker => {
                marker.setStyle({
                    radius: 6,
                    fillColor: '#1d9bf0',
                    color: 'white'
                });
            });
            
            if (schoolMarkers[schoolName]) {
                schoolMarkers[schoolName].setStyle({
                    radius: 10,
                    fillColor: '#ff6b6b',
                    color: 'white'
                });
                
                // Center map on school
                map.setView([school.lat, school.lon], 10);
                schoolMarkers[schoolName].openPopup();
            }
            
            // Highlight card
            document.querySelectorAll('.school-card').forEach(card => {
                card.style.borderColor = '#38444d';
            });
            const selectedCard = document.querySelector(`[data-name="${schoolName}"]`);
            if (selectedCard) {
                selectedCard.style.borderColor = '#1d9bf0';
            }
        }
        
        // Zoom to full map view
        function zoomToFullMap() {
            if (allSchools.length > 0) {
                const bounds = L.latLngBounds(allSchools.map(s => [s.lat, s.lon]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Filter handlers
        document.getElementById('stateFilter').addEventListener('change', function(e) {
            applyFilters();
        });
        
        document.getElementById('programFilter').addEventListener('change', function(e) {
            applyFilters();
        });
        
        document.getElementById('searchInput').addEventListener('input', function(e) {
            applyFilters();
        });
        
        // Apply filters
        function applyFilters() {
            const stateFilter = document.getElementById('stateFilter').value;
            const programFilter = document.getElementById('programFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredSchools = allSchools.filter(school => {
                const stateMatch = !stateFilter || school.state === stateFilter;
                const programMatch = !programFilter || school.programs.includes(programFilter);
                const searchMatch = !searchTerm || 
                    school.name.toLowerCase().includes(searchTerm) ||
                    school.city.toLowerCase().includes(searchTerm) ||
                    school.state.toLowerCase().includes(searchTerm) ||
                    school.programs.some(p => p.toLowerCase().includes(searchTerm));
                return stateMatch && programMatch && searchMatch;
            });
            
            updateStats();
            displaySchools();
            updateMapView();
            updateProgramChart();
            
            // Adjust map view to show filtered schools
            if (filteredSchools.length > 0) {
                const bounds = L.latLngBounds(filteredSchools.map(s => [s.lat, s.lon]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Update map view based on current view mode
        function updateMapView() {
            console.log(`Switching to view: ${currentView}`);
            
            // Clear all layers first
            markersLayer.clearLayers();
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
            if (hexLayer) {
                map.removeLayer(hexLayer);
            }
            
            // Add the appropriate layer based on current view
            if (currentView === 'markers') {
                console.log('Adding markers layer');
                addMarkersToMap();
            } else if (currentView === 'heatmap') {
                console.log('Adding heatmap layer');
                addHeatmapToMap();
            } else if (currentView === 'hexgrid') {
                console.log('Adding hex grid layer');
                addHexGridToMap();
            }
        }
        
        // Get optimal H3 resolution based on zoom level - Updated for bigger hexes
        function getH3Resolution() {
            const zoom = map.getZoom();
            // Use lower resolution numbers for bigger hexes
            if (zoom <= 3) return 2;      // Continental view - very large hexes
            if (zoom <= 5) return 3;      // Multi-state region - large hexes  
            if (zoom <= 7) return 4;      // State level - medium hexes
            if (zoom <= 9) return 5;      // Metro area - smaller hexes
            return 6;                      // City level - smallest hexes
        }
        
        // Add hex grid to map
        function addHexGridToMap() {
            hexLayer.clearLayers();
            const hexData = {};
            const resolution = getH3Resolution();
            
            console.log(`Creating hex grid with resolution ${resolution} for ${filteredSchools.length} schools`);
            
            filteredSchools.forEach(school => {
                try {
                    const h3Index = h3.geoToH3(school.lat, school.lon, resolution);
                    if (!hexData[h3Index]) {
                        hexData[h3Index] = {
                            count: 0,
                            schools: [],
                            programs: {}
                        };
                    }
                    hexData[h3Index].count++;
                    hexData[h3Index].schools.push(school);
                    
                    // Aggregate programs - count each program once per school
                    school.programs.forEach(program => {
                        hexData[h3Index].programs[program] = (hexData[h3Index].programs[program] || 0) + 1;
                    });
                } catch (e) {
                    console.warn('Failed to process school for hex grid:', school.name, e);
                }
            });
            
            console.log(`Created ${Object.keys(hexData).length} hex cells`);
            
            Object.entries(hexData).forEach(([h3Index, data]) => {
                try {
                    const boundary = h3.h3ToGeoBoundary(h3Index);
                    const coordinates = boundary.map(coord => [coord[0], coord[1]]);
                    
                    // Get dominant program (most schools offering it in this hex)
                    const sortedPrograms = Object.entries(data.programs)
                        .sort((a, b) => b[1] - a[1]);
                    const topProgram = sortedPrograms[0] ? sortedPrograms[0][0] : null;
                    
                    // Color based on dominant program
                    const color = topProgram ? getProgramColor(topProgram) : '#8899a6';
                    
                    // Opacity based on density (more schools = more opaque)
                    const opacity = Math.min(0.35 + (data.count / 25), 0.85);
                    
                    // Add text label for count with bigger, more visible styling
                    const center = h3.h3ToGeo(h3Index);
                    
                    // Dynamic sizing based on count
                    const size = Math.max(28, Math.min(50, 20 + data.count * 2));
                    const fontSize = Math.max(14, Math.min(20, 12 + data.count));
                    
                    const label = L.divIcon({
                        className: 'hex-label',
                        html: `<div style="
                            background: rgba(0,0,0,0.9);
                            color: white;
                            border-radius: 50%;
                            width: ${size}px;
                            height: ${size}px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: ${fontSize}px;
                            font-weight: bold;
                            border: 3px solid ${color};
                            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
                            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
                            ">${data.count}</div>`,
                        iconSize: [size, size],
                        iconAnchor: [size/2, size/2]
                    });
                    
                    const marker = L.marker([center[0], center[1]], { icon: label });
                    hexLayer.addLayer(marker);
                    
                    const polygon = L.polygon(coordinates, {
                        color: color,
                        weight: 2,
                        opacity: 0.9,
                        fillColor: color,
                        fillOpacity: opacity
                    });
                    
                    // Sort programs by count for display (top 10)
                    const topProgramsForDisplay = sortedPrograms.slice(0, 10);
                    
                    // Create program bars HTML
                    const maxCount = topProgramsForDisplay[0] ? topProgramsForDisplay[0][1] : 1;
                    const programBarsHtml = topProgramsForDisplay.map(([prog, count]) => {
                        const barWidth = (count / maxCount) * 100;
                        const shortName = prog.length > 25 ? prog.substring(0, 22) + '...' : prog;
                        return `
                            <div style="margin-bottom: 4px;">
                                <div style="font-size: 11px; color: #e1e8ed; margin-bottom: 2px;">${shortName}</div>
                                <div style="display: flex; align-items: center;">
                                    <div style="background: #253341; border-radius: 4px; height: 16px; flex: 1; position: relative;">
                                        <div style="background: ${getProgramColor(prog)}; height: 100%; border-radius: 4px; width: ${barWidth}%;"></div>
                                    </div>
                                    <span style="margin-left: 8px; font-size: 11px; color: #8899a6; min-width: 20px;">${count}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    polygon.bindPopup(`
                        <div style="min-width: 300px; max-width: 400px; background: #15202b; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong style="color: #1d9bf0; font-size: 16px;">Hex Zone Statistics</strong>
                                <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 14px; font-weight: bold;">${data.count}</span>
                            </div>
                            ${topProgram ? `
                            <div style="margin-bottom: 12px; padding: 10px; background: rgba(${parseInt(color.slice(1,3), 16)}, ${parseInt(color.slice(3,5), 16)}, ${parseInt(color.slice(5,7), 16)}, 0.15); border-radius: 8px; border-left: 3px solid ${color};">
                                <div style="color: #8899a6; font-size: 10px; text-transform: uppercase; margin-bottom: 4px;">Dominant Program</div>
                                <div style="color: #e1e8ed; font-size: 14px; font-weight: 600;">${topProgram}</div>
                                <div style="color: #8899a6; font-size: 11px; margin-top: 2px;">${sortedPrograms[0][1]} schools (${Math.round(sortedPrograms[0][1] / data.count * 100)}%)</div>
                            </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                <div style="background: #253341; padding: 8px; border-radius: 6px;">
                                    <div style="color: #8899a6; font-size: 10px; text-transform: uppercase;">Schools</div>
                                    <div style="color: #e1e8ed; font-size: 18px; font-weight: bold;">${data.count}</div>
                                </div>
                                <div style="background: #253341; padding: 8px; border-radius: 6px;">
                                    <div style="color: #8899a6; font-size: 10px; text-transform: uppercase;">Programs</div>
                                    <div style="color: #e1e8ed; font-size: 18px; font-weight: bold;">${Object.keys(data.programs).length}</div>
                                </div>
                            </div>
                            ${topProgramsForDisplay.length > 0 ? `
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #e1e8ed; font-size: 12px;">Top Programs in Zone:</strong>
                                </div>
                                ${programBarsHtml}
                            ` : ''}
                            ${data.schools.length > 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #38444d;">
                                    <strong style="color: #e1e8ed; font-size: 12px;">Schools in Zone:</strong>
                                    <div style="max-height: 150px; overflow-y: auto; margin-top: 8px;">
                                        ${data.schools.slice(0, 10).map(s => `
                                            <div style="color: #8899a6; font-size: 11px; margin-bottom: 4px;">‚Ä¢ ${s.name}</div>
                                        `).join('')}
                                        ${data.schools.length > 10 ? `<div style="color: #8899a6; font-size: 11px; font-style: italic;">...and ${data.schools.length - 10} more</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `, {
                        maxWidth: 400,
                        className: 'custom-popup'
                    });
                    
                    hexLayer.addLayer(polygon);
                } catch (e) {
                    console.warn('Failed to create hex cell:', h3Index, e);
                }
            });
            
            map.addLayer(hexLayer);
            console.log(`Hex grid rendered with ${Object.keys(hexData).length} cells`);
        }
        
        // Add heatmap to map
        function addHeatmapToMap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            const heatPoints = [];
            filteredSchools.forEach(school => {
                heatPoints.push([school.lat, school.lon, 1]);
            });
            
            if (heatPoints.length > 0) {
                heatmapLayer = L.heatLayer(heatPoints, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.4: 'blue',
                        0.6: 'cyan',
                        0.7: 'lime',
                        0.8: 'yellow',
                        1.0: 'red'
                    }
                });
                map.addLayer(heatmapLayer);
            }
        }
        
        // Update mode indicator
        function updateModeIndicator() {
            const zoom = map.getZoom();
            const indicator = document.getElementById('modeIndicator');
            const modeText = document.getElementById('modeText');
            
            if (currentView === 'markers' && zoom >= 6) {
                indicator.style.display = 'block';
                modeText.textContent = `üìç Showing viewport only (zoom ${Math.round(zoom)}) ‚Ä¢ Pan to load more`;
            } else if (currentView === 'hexgrid') {
                indicator.style.display = 'block';
                const res = getH3Resolution();
                modeText.textContent = `‚¨° Hex resolution: ${res} ‚Ä¢ Zoom to adjust granularity`;
            } else if (currentView === 'heatmap') {
                indicator.style.display = 'block';
                modeText.textContent = `üå°Ô∏è Showing all ${filteredSchools.length} schools as density map`;
            } else {
                indicator.style.display = 'block';
                modeText.textContent = `üìç Showing all ${filteredSchools.length} schools`;
            }
        }
        
        // Set view mode
        function setView(view) {
            console.log(`Setting view to: ${view}`);
            currentView = view;
            
            // Update button states
            document.getElementById('markersBtn').classList.toggle('active', view === 'markers');
            document.getElementById('heatmapBtn').classList.toggle('active', view === 'heatmap');
            document.getElementById('hexgridBtn').classList.toggle('active', view === 'hexgrid');
            
            // Auto-show legend when hex grid is active
            const legend = document.getElementById('programLegend');
            const toggle = document.getElementById('legendToggle');
            if (view === 'hexgrid') {
                legend.classList.add('active');
                toggle.textContent = 'üé® Hide Legend';
            } else {
                legend.classList.remove('active');
                toggle.textContent = 'üé® Show Legend';
            }
            
            updateModeIndicator();
            updateMapView();
        }
        
        // Update program distribution chart
        function updateProgramChart() {
            // Destroy existing chart if it exists
            if (programChart) {
                programChart.destroy();
            }
            
            // Count programs from schools in current viewport
            const schoolsToShow = getViewportSchools();
            const programCounts = {};
            schoolsToShow.forEach(school => {
                school.programs.forEach(program => {
                    programCounts[program] = (programCounts[program] || 0) + 1;
                });
            });
            
            // Sort programs by count and take top 10
            const sortedPrograms = Object.entries(programCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedPrograms.map(([program]) => program.length > 20 ? program.substring(0, 17) + '...' : program);
            const data = sortedPrograms.map(([, count]) => count);
            
            // Update chart title
            const chartTitle = document.getElementById('chartTitle');
            chartTitle.textContent = `üìä Program Distribution (Viewport: ${schoolsToShow.length} schools)`;
            
            // Create chart
            const ctx = document.getElementById('programChart').getContext('2d');
            programChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Schools',
                        data: data,
                        backgroundColor: [
                            '#1d9bf0', '#ff6b6b', '#6bcf7f', '#ffd93d', '#4ecdc4',
                            '#a8e6cf', '#ffaaa5', '#ffd3a5', '#a8c8ec', '#dda0dd'
                        ],
                        borderColor: '#38444d',
                        borderWidth: 2,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const program = sortedPrograms[index][0];
                            filterByProgram(program);
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#15202b',
                            titleColor: '#e1e8ed',
                            bodyColor: '#e1e8ed',
                            borderColor: '#38444d',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return sortedPrograms[context[0].dataIndex][0];
                                },
                                label: function(context) {
                                    return `${context.parsed.y} schools`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#8899a6',
                                font: {
                                    size: 10,
                                    weight: '500'
                                },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: {
                                color: '#38444d',
                                drawBorder: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8899a6',
                                font: {
                                    size: 10,
                                    weight: '500'
                                },
                                stepSize: 1
                            },
                            grid: {
                                color: '#38444d',
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        // Filter by program
        function filterByProgram(program) {
            document.getElementById('programFilter').value = program;
            applyFilters();
        }
        
        // Show all programs for a school
        function showAllPrograms(schoolName) {
            const school = getViewportSchools().find(s => s.name === schoolName);
            if (school) {
                alert(`All programs at ${schoolName}:\n\n${school.programs.join(', ')}`);
            }
        }
        
        // Handle school submission
        document.getElementById('schoolSubmissionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            // Collect form data
            const schoolCity = document.getElementById('schoolCity').value;
            const schoolState = document.getElementById('schoolState').value;
            const formData = {
                schoolName: document.getElementById('schoolName').value,
                schoolCity: schoolCity,
                schoolState: schoolState,
                schoolLocation: `${schoolCity}, ${schoolState}`,
                schoolWebsite: document.getElementById('schoolWebsite').value,
                schoolPrograms: document.getElementById('schoolPrograms').value,
                submitterEmail: document.getElementById('submitterEmail').value,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
            
            // Send email using mailto link
            const subject = `New Trade School Submission: ${formData.schoolName}`;
            const body = `New trade school submission:\n\n` +
                        `School Name: ${formData.schoolName}\n` +
                        `City: ${formData.schoolCity}\n` +
                        `State: ${formData.schoolState}\n` +
                        `Location: ${formData.schoolLocation}\n` +
                        `Website: ${formData.schoolWebsite || 'Not provided'}\n` +
                        `Programs: ${formData.schoolPrograms || 'Not provided'}\n` +
                        `Submitted by: ${formData.submitterEmail || 'Anonymous'}\n` +
                        `Submitted at: ${formData.timestamp}\n` +
                        `User Agent: ${formData.userAgent}`;
            
            // Create mailto link
            const mailtoLink = `mailto:tom@bomforge.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Reset form after a delay
            setTimeout(() => {
                document.getElementById('schoolSubmissionForm').reset();
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                alert('Thank you! Your email client should open with the submission details. Please send the email to complete the submission.');
            }, 1000);
        });
        
        // Get schools visible in current viewport
        // Smart filtering: only applies to markers view for performance
        function getViewportSchools() {
            // For hex grid and heatmap, always show all filtered data (aggregation handles it)
            if (currentView === 'hexgrid' || currentView === 'heatmap') {
                return filteredSchools;
            }
            
            // For markers view at high zoom, show viewport only to avoid clutter
            const zoom = map.getZoom();
            if (currentView === 'markers' && zoom >= 6) {
                const bounds = map.getBounds();
                return filteredSchools.filter(school => {
                    return bounds.contains([school.lat, school.lon]);
                });
            }
            
            // At national zoom level, show all
            return filteredSchools;
        }
        
        // Update viewport-based filtering
        function updateViewportFiltering() {
            updateStats();
            displaySchools();
            updateProgramChart();
            updateModeIndicator();
            
            // Re-render hex grid if active (zoom-dependent resolution)
            if (currentView === 'hexgrid') {
                const zoom = map.getZoom();
                const resolution = getH3Resolution();
                console.log(`Zoom changed to ${zoom}, updating hex grid with resolution ${resolution}`);
                addHexGridToMap();
            }
        }
        
        // Initialize
        loadGeocodedData();
        
        // Add viewport change listeners
        map.on('moveend', updateViewportFiltering);
        map.on('zoomend', updateViewportFiltering);
    </script>
</body>
</html>
