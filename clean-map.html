<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Trade Schools Map | BOMForge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #e1e8ed;
            height: 100vh;
            display: flex;
        }
        
        #map {
            flex: 1;
            height: 100vh;
            background: #1a1f2e;
        }
        
        #sidebar {
            width: 400px;
            background: #192734;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #38444d;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            background: #15202b;
            border-bottom: 1px solid #38444d;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1d9bf0;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat {
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1d9bf0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8899a6;
            text-transform: uppercase;
        }
        
        .filters {
            padding: 20px;
            border-bottom: 1px solid #38444d;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #8899a6;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 8px;
            color: #e1e8ed;
            font-size: 14px;
            cursor: pointer;
        }
        
        .filter-select:hover {
            border-color: #1d9bf0;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #1d9bf0;
            box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 8px;
            color: #e1e8ed;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .search-input:hover {
            border-color: #1d9bf0;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1d9bf0;
            box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .view-btn {
            flex: 1;
            padding: 8px 12px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e1e8ed;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-btn:hover {
            border-color: #1d9bf0;
            background: #1d9bf0;
            color: white;
        }
        
        .view-btn.active {
            background: #1d9bf0;
            border-color: #1d9bf0;
            color: white;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
        }
        
        .chart-title {
            color: #e1e8ed;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .chart-canvas {
            max-height: 300px;
        }
        
        .submission-form {
            margin-top: 20px;
            padding: 15px;
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 8px;
        }
        
        .form-title {
            color: #e1e8ed;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #8899a6;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e1e8ed;
            font-size: 12px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1d9bf0;
        }
        
        .form-textarea {
            width: 100%;
            padding: 8px;
            background: #253341;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e1e8ed;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #1d9bf0;
        }
        
        .submit-btn {
            width: 100%;
            padding: 10px;
            background: #1d9bf0;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .submit-btn:hover {
            background: #0d8bd9;
        }
        
        .submit-btn:disabled {
            background: #38444d;
            cursor: not-allowed;
        }
        
        .school-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .school-card {
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .school-card:hover {
            border-color: #1d9bf0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 155, 240, 0.1);
        }
        
        .school-name {
            font-size: 16px;
            font-weight: 600;
            color: #e1e8ed;
            margin-bottom: 8px;
        }
        
        .school-location {
            font-size: 14px;
            color: #8899a6;
            margin-bottom: 10px;
        }
        
        .school-programs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .program-tag {
            background: #1d9bf0;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .program-tag:hover {
            background: #0d8bd9;
            transform: scale(1.05);
        }
        
        .school-contact {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #38444d;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #8899a6;
        }
        
        .contact-item a {
            color: #1d9bf0;
            text-decoration: none;
        }
        
        .contact-item a:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #8899a6;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #8899a6;
        }
        
        /* Map markers */
        .school-marker {
            background: #1d9bf0;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .school-marker.selected {
            background: #ff6b6b;
            width: 16px;
            height: 16px;
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2);
        }
        
        /* Popup styles */
        .leaflet-popup-content-wrapper {
            background: #15202b;
            border: 1px solid #38444d;
            border-radius: 12px;
        }
        
        .leaflet-popup-content {
            margin: 12px;
            color: #e1e8ed;
        }
        
        .leaflet-popup-tip {
            background: #15202b;
            border: 1px solid #38444d;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 50vh;
            }
            
            #map {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="sidebar">
        <div class="header">
            <h1>üéì Trade Schools Directory</h1>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalSchools">0</div>
                    <div class="stat-label">Schools</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalStates">0</div>
                    <div class="stat-label">States</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="visibleCount">0</div>
                    <div class="stat-label">Visible</div>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Search Schools</label>
                <input type="text" class="search-input" id="searchInput" placeholder="Search by name, city, or program...">
            </div>
            <div class="view-controls">
                <button class="view-btn active" id="markersBtn" onclick="setView('markers')">Markers</button>
                <button class="view-btn" id="heatmapBtn" onclick="setView('heatmap')">Heat Map</button>
                <button class="view-btn" id="hexgridBtn" onclick="setView('hexgrid')">Hex Grid</button>
            </div>
            <div class="filter-group">
                <label class="filter-label">Filter by State</label>
                <select class="filter-select" id="stateFilter">
                    <option value="">All States</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Filter by Program</label>
                <select class="filter-select" id="programFilter">
                    <option value="">All Programs</option>
                </select>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üìä Program Distribution</div>
            <canvas id="programChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="submission-form">
            <div class="form-title">üè´ Submit a School</div>
            <form id="schoolSubmissionForm">
                <div class="form-group">
                    <label class="form-label">School Name *</label>
                    <input type="text" class="form-input" id="schoolName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">City, State *</label>
                    <input type="text" class="form-input" id="schoolLocation" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" class="form-input" id="schoolWebsite">
                </div>
                <div class="form-group">
                    <label class="form-label">Programs Offered</label>
                    <textarea class="form-textarea" id="schoolPrograms" placeholder="List programs separated by commas..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Email</label>
                    <input type="email" class="form-input" id="submitterEmail">
                </div>
                <button type="submit" class="submit-btn" id="submitBtn">Submit School</button>
            </form>
        </div>
        
        <div class="school-list" id="schoolList">
            <div class="loading">Loading schools...</div>
        </div>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [39.8283, -98.5795],
            zoom: 4,
            minZoom: 3,
            maxZoom: 18
        });
        
        // Add dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Chart instance
        let programChart = null;
        
        // Data storage
        let allSchools = [];
        let filteredSchools = [];
        let schoolMarkers = {};
        let markersLayer = L.layerGroup().addTo(map);
        let heatmapLayer = null;
        let hexLayer = L.layerGroup();
        let selectedMarker = null;
        let currentView = 'markers';
        
        // Load geocoded data
        function loadGeocodedData() {
            console.log('Starting to load geocoded data...');
            Papa.parse('schools/trade_schools_geocoded_fixed.csv', {
                download: true,
                header: true,
                complete: function(geoResults) {
                    console.log('Geocoded data loaded:', geoResults.data.length, 'rows');
                    // Load matchmaking data for programs
                    Papa.parse('schools/matchmaking_index.csv', {
                        download: true,
                        header: true,
                        complete: function(matchResults) {
                            console.log('Matchmaking data loaded:', matchResults.data.length, 'rows');
                            processData(geoResults.data, matchResults.data);
                        },
                        error: function(error) {
                            console.error('Error loading matchmaking data:', error);
                            document.getElementById('schoolList').innerHTML = '<div class="no-results">Error loading matchmaking data. Please check the console.</div>';
                        }
                    });
                },
                error: function(error) {
                    console.error('Error loading geocoded data:', error);
                    document.getElementById('schoolList').innerHTML = '<div class="no-results">Error loading geocoded data. Please check the console.</div>';
                }
            });
        }
        
        // Process and merge data
        function processData(geoData, matchData) {
            // Group matchmaking data by institution
            const schoolPrograms = {};
            matchData.forEach(row => {
                const key = `${row['Institution Name']}_${row.State}_${row.City}`;
                if (!schoolPrograms[key]) {
                    schoolPrograms[key] = {
                        programs: [],
                        email: row['Contact Email'] || '',
                        website: row.Website || ''
                    };
                }
                if (row.program) {
                    schoolPrograms[key].programs.push(row.program);
                }
            });
            
            // Process geocoded schools
            allSchools = [];
            geoData.forEach(row => {
                if (row.geocoded === 'True' && row.lat && row.lon) {
                    const key = `${row['Institution Name']}_${row.State}_${row.City}`;
                    const programData = schoolPrograms[key] || { programs: [], email: '', website: '' };
                    
                    // Deduplicate programs
                    const uniquePrograms = [...new Set(programData.programs)];
                    
                    // Clean website URL (remove trailing slash)
                    let cleanWebsite = programData.website || '';
                    if (cleanWebsite && cleanWebsite.endsWith('/')) {
                        cleanWebsite = cleanWebsite.slice(0, -1);
                    }
                    
                    allSchools.push({
                        name: row['Institution Name'],
                        state: row.State,
                        city: row.City,
                        lat: parseFloat(row.lat),
                        lon: parseFloat(row.lon),
                        programs: uniquePrograms,
                        website: cleanWebsite
                    });
                }
            });
            
            console.log(`Loaded ${allSchools.length} schools with coordinates`);
            console.log(`Note: ${geoData.filter(r => r.geocoded === 'False').length} schools failed geocoding and are not displayed`);
            
            // Show warning about missing schools
            if (geoData.filter(r => r.geocoded === 'False').length > 0) {
                const missingCount = geoData.filter(r => r.geocoded === 'False').length;
                const totalCount = geoData.length - 1; // minus header
                alert(`‚ö†Ô∏è Data Status:\n\n‚úÖ ${allSchools.length} schools successfully mapped\n‚ùå ${missingCount} schools missing coordinates\nüìä Total: ${totalCount} schools in database\n\nThe ${missingCount} schools without coordinates cannot be displayed on the map.`);
            }
            
            // Initialize UI
            filteredSchools = [...allSchools];
            populateFilters();
            updateStats();
            displaySchools();
            updateMapView();
            updateProgramChart();
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            // State filter
            const states = {};
            const programs = {};
            
            allSchools.forEach(school => {
                // Count states
                if (school.state) {
                    states[school.state] = (states[school.state] || 0) + 1;
                }
                
                // Count programs
                school.programs.forEach(program => {
                    programs[program] = (programs[program] || 0) + 1;
                });
            });
            
            // Populate state filter
            const stateFilter = document.getElementById('stateFilter');
            Object.entries(states)
                .sort((a, b) => b[1] - a[1])
                .forEach(([state, count]) => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = `${state} (${count})`;
                    stateFilter.appendChild(option);
                });
            
            // Populate program filter
            const programFilter = document.getElementById('programFilter');
            Object.entries(programs)
                .sort((a, b) => b[1] - a[1])
                .forEach(([program, count]) => {
                    const option = document.createElement('option');
                    option.value = program;
                    option.textContent = `${program} (${count})`;
                    programFilter.appendChild(option);
                });
        }
        
        // Update statistics
        function updateStats() {
            const stateCount = new Set(allSchools.map(s => s.state)).size;
            document.getElementById('totalSchools').textContent = allSchools.length;
            document.getElementById('totalStates').textContent = stateCount;
            document.getElementById('visibleCount').textContent = filteredSchools.length;
        }
        
        // Display schools in sidebar
        function displaySchools() {
            const container = document.getElementById('schoolList');
            
            if (filteredSchools.length === 0) {
                container.innerHTML = '<div class="no-results">No schools found matching your filters</div>';
                return;
            }
            
            container.innerHTML = filteredSchools.map(school => {
                const websiteUrl = school.website ? 
                    (school.website.startsWith('http') ? school.website : `https://${school.website}`) : '';
                
                return `
                    <div class="school-card" data-name="${school.name}" onclick="selectSchool('${school.name}')">
                        <div class="school-name">${school.name}</div>
                        <div class="school-location">üìç ${school.city}, ${school.state}</div>
                        ${school.programs.length > 0 ? `
                            <div class="school-programs">
                                ${school.programs.slice(0, 4).map(p => 
                                    `<span class="program-tag" onclick="filterByProgram('${p}')">${p}</span>`
                                ).join('')}
                                ${school.programs.length > 4 ? 
                                    `<span class="program-tag" onclick="showAllPrograms('${school.name}')">+${school.programs.length - 4} more</span>` : ''}
                            </div>
                        ` : ''}
                        ${websiteUrl ? `
                            <div class="school-contact">
                                <div class="contact-item">
                                    üåê <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer">
                                        ${school.website}
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Add markers to map
        function addMarkersToMap() {
            markersLayer.clearLayers();
            schoolMarkers = {};
            
            filteredSchools.forEach(school => {
                const marker = L.circleMarker([school.lat, school.lon], {
                    radius: 6,
                    fillColor: '#1d9bf0',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Create popup
                const websiteUrl = school.website ? 
                    (school.website.startsWith('http') ? school.website : `https://${school.website}`) : '';
                
                const popupContent = `
                    <div style="min-width: 200px;">
                        <strong style="color: #1d9bf0;">${school.name}</strong><br>
                        üìç ${school.city}, ${school.state}<br>
                        ${websiteUrl ? `üåê <a href="${websiteUrl}" target="_blank">${school.website}</a><br>` : ''}
                        ${school.programs.length > 0 ? `<br><strong>Programs:</strong><br>${school.programs.join(', ')}` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', function() {
                    selectSchool(school.name);
                    // Scroll to card in sidebar
                    const card = document.querySelector(`[data-name="${school.name}"]`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
                
                markersLayer.addLayer(marker);
                schoolMarkers[school.name] = marker;
            });
        }
        
        // Select school
        function selectSchool(schoolName) {
            const school = filteredSchools.find(s => s.name === schoolName);
            if (!school) return;
            
            // Update marker styles
            Object.values(schoolMarkers).forEach(marker => {
                marker.setStyle({
                    radius: 6,
                    fillColor: '#1d9bf0',
                    color: 'white'
                });
            });
            
            if (schoolMarkers[schoolName]) {
                schoolMarkers[schoolName].setStyle({
                    radius: 10,
                    fillColor: '#ff6b6b',
                    color: 'white'
                });
                
                // Center map on school
                map.setView([school.lat, school.lon], 10);
                schoolMarkers[schoolName].openPopup();
            }
            
            // Highlight card
            document.querySelectorAll('.school-card').forEach(card => {
                card.style.borderColor = '#38444d';
            });
            const selectedCard = document.querySelector(`[data-name="${schoolName}"]`);
            if (selectedCard) {
                selectedCard.style.borderColor = '#1d9bf0';
            }
        }
        
        // Filter handlers
        document.getElementById('stateFilter').addEventListener('change', function(e) {
            applyFilters();
        });
        
        document.getElementById('programFilter').addEventListener('change', function(e) {
            applyFilters();
        });
        
        document.getElementById('searchInput').addEventListener('input', function(e) {
            applyFilters();
        });
        
        // Apply filters
        function applyFilters() {
            const stateFilter = document.getElementById('stateFilter').value;
            const programFilter = document.getElementById('programFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredSchools = allSchools.filter(school => {
                const stateMatch = !stateFilter || school.state === stateFilter;
                const programMatch = !programFilter || school.programs.includes(programFilter);
                const searchMatch = !searchTerm || 
                    school.name.toLowerCase().includes(searchTerm) ||
                    school.city.toLowerCase().includes(searchTerm) ||
                    school.state.toLowerCase().includes(searchTerm) ||
                    school.programs.some(p => p.toLowerCase().includes(searchTerm));
                return stateMatch && programMatch && searchMatch;
            });
            
            updateStats();
            displaySchools();
            updateMapView();
            updateProgramChart();
            
            // Adjust map view to show filtered schools
            if (filteredSchools.length > 0) {
                const bounds = L.latLngBounds(filteredSchools.map(s => [s.lat, s.lon]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Update map view based on current view mode
        function updateMapView() {
            if (currentView === 'markers') {
                addMarkersToMap();
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
                map.removeLayer(hexLayer);
            } else if (currentView === 'heatmap') {
                addHeatmapToMap();
                markersLayer.clearLayers();
                map.removeLayer(hexLayer);
            } else if (currentView === 'hexgrid') {
                addHexGridToMap();
                markersLayer.clearLayers();
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
            }
        }
        
        // Add hex grid to map
        function addHexGridToMap() {
            hexLayer.clearLayers();
            const hexData = {};
            const resolution = 4;
            
            filteredSchools.forEach(school => {
                const h3Index = h3.geoToH3(school.lat, school.lon, resolution);
                if (!hexData[h3Index]) {
                    hexData[h3Index] = {
                        count: 0,
                        schools: []
                    };
                }
                hexData[h3Index].count++;
                hexData[h3Index].schools.push(school);
            });
            
            Object.entries(hexData).forEach(([h3Index, data]) => {
                const boundary = h3.h3ToGeoBoundary(h3Index);
                const coordinates = boundary.map(coord => [coord[0], coord[1]]);
                
                const opacity = Math.min(0.2 + (data.count / 50), 0.8);
                const color = data.count > 20 ? '#ff6b6b' : 
                             data.count > 10 ? '#ffd93d' : 
                             data.count > 5 ? '#6bcf7f' : '#4ecdc4';
                
                const polygon = L.polygon(coordinates, {
                    color: color,
                    weight: 1,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: opacity
                });
                
                polygon.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="color: #1d9bf0;">H3 Hexagon</strong><br>
                        üìä Schools: ${data.count}<br>
                        üî¢ H3 Index: ${h3Index.substring(0,10)}...<br>
                        üìç Density: ${(data.count / 10).toFixed(1)} per 100km¬≤<br>
                        ${data.schools.length > 0 ? `<br><strong>Sample Schools:</strong><br>${data.schools.slice(0, 3).map(s => s.name).join('<br>')}${data.schools.length > 3 ? '<br>...' : ''}` : ''}
                    </div>
                `);
                
                hexLayer.addLayer(polygon);
            });
            
            map.addLayer(hexLayer);
        }
        
        // Add heatmap to map
        function addHeatmapToMap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            const heatPoints = [];
            filteredSchools.forEach(school => {
                heatPoints.push([school.lat, school.lon, 1]);
            });
            
            if (heatPoints.length > 0) {
                heatmapLayer = L.heatLayer(heatPoints, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.4: 'blue',
                        0.6: 'cyan',
                        0.7: 'lime',
                        0.8: 'yellow',
                        1.0: 'red'
                    }
                });
                map.addLayer(heatmapLayer);
            }
        }
        
        // Set view mode
        function setView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('markersBtn').classList.toggle('active', view === 'markers');
            document.getElementById('heatmapBtn').classList.toggle('active', view === 'heatmap');
            document.getElementById('hexgridBtn').classList.toggle('active', view === 'hexgrid');
            
            updateMapView();
        }
        
        // Update program distribution chart
        function updateProgramChart() {
            // Destroy existing chart if it exists
            if (programChart) {
                programChart.destroy();
            }
            
            // Count programs
            const programCounts = {};
            filteredSchools.forEach(school => {
                school.programs.forEach(program => {
                    programCounts[program] = (programCounts[program] || 0) + 1;
                });
            });
            
            // Sort programs by count and take top 10
            const sortedPrograms = Object.entries(programCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedPrograms.map(([program]) => program.length > 20 ? program.substring(0, 17) + '...' : program);
            const data = sortedPrograms.map(([, count]) => count);
            
            // Create chart
            const ctx = document.getElementById('programChart').getContext('2d');
            programChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Schools',
                        data: data,
                        backgroundColor: [
                            '#1d9bf0', '#ff6b6b', '#6bcf7f', '#ffd93d', '#4ecdc4',
                            '#a8e6cf', '#ffaaa5', '#ffd3a5', '#a8c8ec', '#dda0dd'
                        ],
                        borderColor: '#38444d',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const program = sortedPrograms[index][0];
                            filterByProgram(program);
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#8899a6',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: '#38444d'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8899a6',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: '#38444d'
                            }
                        }
                    }
                }
            });
        }
        
        // Filter by program
        function filterByProgram(program) {
            document.getElementById('programFilter').value = program;
            applyFilters();
        }
        
        // Show all programs for a school
        function showAllPrograms(schoolName) {
            const school = filteredSchools.find(s => s.name === schoolName);
            if (school) {
                alert(`All programs at ${schoolName}:\n\n${school.programs.join(', ')}`);
            }
        }
        
        // Handle school submission
        document.getElementById('schoolSubmissionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            // Collect form data
            const formData = {
                schoolName: document.getElementById('schoolName').value,
                schoolLocation: document.getElementById('schoolLocation').value,
                schoolWebsite: document.getElementById('schoolWebsite').value,
                schoolPrograms: document.getElementById('schoolPrograms').value,
                submitterEmail: document.getElementById('submitterEmail').value,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
            
            // Send email using mailto link
            const subject = `New Trade School Submission: ${formData.schoolName}`;
            const body = `New trade school submission:\n\n` +
                        `School Name: ${formData.schoolName}\n` +
                        `Location: ${formData.schoolLocation}\n` +
                        `Website: ${formData.schoolWebsite || 'Not provided'}\n` +
                        `Programs: ${formData.schoolPrograms || 'Not provided'}\n` +
                        `Submitted by: ${formData.submitterEmail || 'Anonymous'}\n` +
                        `Submitted at: ${formData.timestamp}\n` +
                        `User Agent: ${formData.userAgent}`;
            
            // Create mailto link
            const mailtoLink = `mailto:tom@bomforge.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Reset form after a delay
            setTimeout(() => {
                document.getElementById('schoolSubmissionForm').reset();
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                alert('Thank you! Your email client should open with the submission details. Please send the email to complete the submission.');
            }, 1000);
        });
        
        // Initialize
        loadGeocodedData();
    </script>
</body>
</html>
